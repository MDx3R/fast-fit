{% extends "base.html" %}

{% block title %}–ó–¥–æ—Ä–æ–≤–∞—è –∏ –±—ã—Å—Ç—Ä–∞—è –µ–¥–∞{% endblock %}

{% block additional_styles %}
.category-buttons {
    scrollbar-width: none;
}
.category-buttons::-webkit-scrollbar {
    display: none;
}
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.quantity-input {
    -moz-appearance: textfield;
}
.description {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}
#dish-modal {
    backdrop-filter: blur(4px);
}
#dish-modal .modal-content {
    max-height: 90vh;
    overflow-y: auto;
    scrollbar-width: thin;
}
#dish-modal .modal-content::-webkit-scrollbar {
    width: 6px;
}
#dish-modal .modal-content::-webkit-scrollbar-thumb {
    background-color: #d1d5db;
    border-radius: 3px;
}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Success Message -->
    <div id="cart-message" class="hidden text-sm text-green-500 mb-4 text-center"></div>

    <!-- Banner -->
    <div class="relative bg-cover bg-center rounded-2xl p-12 text-center text-white mb-10" style="background-image: url('{{ banner_image|default('https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=1200') }}')">
        <div class="absolute inset-0 bg-black opacity-40 rounded-2xl"></div>
        <div class="relative z-10">
            <h1 class="text-4xl sm:text-5xl font-bold mb-4">{{ banner_title|default('–ó–¥–æ—Ä–æ–≤–∞—è –µ–¥–∞ —Å FastFit') }}</h1>
            <p class="text-lg sm:text-xl mb-6">{{ banner_subtitle|default('–í–∫—É—Å–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –±–ª—é–¥–∞ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π –∏–ª–∏ —Å–∞–º–æ–≤—ã–≤–æ–∑–æ–º') }}</p>
            <a href="{{ url_for('menu') }}" class="inline-block bg-green-500 text-white py-3 px-8 rounded-full font-semibold hover:bg-green-600 transition-colors">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–µ–Ω—é</a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md mb-10">
        <div class="flex flex-col lg:flex-row lg:items-center gap-6">
            <!-- Categories -->
            <div class="flex-1">
                <h3 class="text-lg font-semibold mb-3">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <div class="category-buttons flex gap-2 sm:gap-3 overflow-x-auto pb-2 scroll-smooth -mx-4 sm:mx-0 px-4 sm:px-0">
                    {% for category in categories %}
                    <button class="filter-btn min-w-fit px-3 sm:px-4 py-2 border border-gray-300 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-orange-500 hover:text-white hover:border-orange-500 transition-all" data-category="{{ category.id }}">{{ category.name }}</button>
                    {% endfor %}
                </div>
            </div>
            <!-- Calories Filter -->
            <div class="w-64 lg:flex-shrink-0">
                <h3 class="text-lg font-semibold mb-3">–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å</h3>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">üçé</span>
                    <select id="calories" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                        {% for calorie_option in calorie_options %}
                        <option value="{{ calorie_option.value }}">{{ calorie_option.label }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
        {% for item in menu_items %}
        <div class="menu-item bg-white rounded-2xl shadow-md overflow-hidden transform hover:-translate-y-1 transition-transform cursor-pointer relative flex flex-col h-full"
             data-dish-id="{{ item.id }}"
             data-category="{{ item.category }}"
             data-calories="{{ item.calories }}"
             data-name="{{ item.name }}"
             data-description="{{ item.description }}"
             data-price="{{ item.price }}"
             data-protein="{{ item.proteins }}"
             data-fat="{{ item.fats }}"
             data-carbs="{{ item.carbohydrates }}"
             data-image="{{ item.image }}">
            <img src="{{ item.image }}" alt="{{ item.name }}" class="w-full h-48 object-cover">
            <div class="p-5 text-center flex flex-col flex-grow">
                <h3 class="text-lg font-semibold mb-2">{{ item.name }}</h3>
                <p class="text-sm text-gray-600 mb-4 description">{{ item.description }}</p>
                <!-- <p class="text-sm text-gray-600 mb-4 mt-auto">{{ item.calories }} –∫–∫–∞–ª</p> -->
                <div class="text-sm text-gray-600 mb-3 mt-auto">
                    <span>üî• {{ item.calories }} –∫–∫–∞–ª</span>
                    <span>üí™ {{ item.proteins }} –≥</span>
                    <span>ü•ë {{ item.fats }} –≥</span>
                    <span>üçû {{ item.carbohydrates }} –≥</span>
                </div>

                <!-- Cart Controls -->
                <div class="flex justify-center items-center gap-2 cart-controls" data-dish-id="{{ item.id }}">
                    <button class="add-to-cart bg-orange-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-orange-600 transition-colors">
                        –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
                    </button>
                    <div class="quantity-controls hidden flex items-center gap-2">
                        <button class="decrease-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">-</button>
                        <input type="number" class="quantity-input w-12 text-center border border-gray-300 rounded-lg" value="0" min="0">
                        <button class="increase-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">+</button>
                    </div>
                </div>
                <div class="absolute top-3 left-3 bg-white shadow-md px-3 py-1 rounded-full text-orange-500 font-bold text-sm">
                    {{ item.price }} ‚ÇΩ
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Dish Modal Popup -->
    <div id="dish-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-2xl p-6 max-w-lg w-full relative">
            <button id="close-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            <img id="modal-image" src="" alt="" class="w-full h-64 object-cover rounded-lg mb-4">
            <h2 id="modal-name" class="text-2xl font-bold mb-2"></h2>
            <p id="modal-description" class="text-sm text-gray-600 mb-4"></p>
            <p id="modal-price" class="text-lg font-bold text-orange-500 mb-4"></p>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <p class="text-sm text-gray-800">–ö–∞–ª–æ—Ä–∏–∏:</p>
                    <p id="modal-calories" class="font-semibold"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-800">–ë–µ–ª–∫–∏:</p>
                    <p id="modal-protein" class="font-semibold"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-800">–ñ–∏—Ä—ã:</p>
                    <p id="modal-fat" class="font-semibold"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-800">–£–≥–ª–µ–≤–æ–¥—ã:</p>
                    <p id="modal-carbs" class="font-semibold"></p>
                </div>
            </div>
            <button id="modal-add-to-cart" class="bg-orange-500 text-white py-2 px-6 rounded-full font-semibold hover:bg-orange-600 transition-colors w-full">–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>
    </div>
</div>

<a href="{{ url_for('cart') }}">
    <div class="fixed bottom-8 right-8 bg-orange-500 text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-lg cursor-pointer hover:scale-110 transition-transform">
        üõí
    </div>
</a>
{% endblock %}

{% block scripts %}
<script>
    // Cart management functions
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '[]');
    }

    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCounter();
        updateAllCartControls();
    }

    function addToCart(dish, quantity = 1) {
        if (quantity < 1) {
            //showCartMessage('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 1');
            return;
        }
        const cart = getCart();
        const existingItem = cart.find(item => item.dish_id === dish.dish_id);
        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            cart.push({ ...dish, quantity });
        }
        saveCart(cart);
        //showCartMessage(`–î–æ–±–∞–≤–ª–µ–Ω–æ: ${dish.name}`);
    }

    function updateCartItemQuantity(dishId, newQuantity) {
        const cart = getCart();
        const itemIndex = cart.findIndex(item => item.dish_id === dishId);
        if (itemIndex !== -1) {
            if (newQuantity <= 0) {
                cart.splice(itemIndex, 1);
            } else {
                cart[itemIndex].quantity = newQuantity;
            }
            saveCart(cart);
        }
    }

    function updateCartCounter() {
        const cart = getCart();
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const counter = document.getElementById('cart-counter');
        if (counter) {
            counter.textContent = totalItems || '';
            counter.classList.toggle('hidden', totalItems === 0);
        }
    }

    function showCartMessage(message) {
        const messageDiv = document.getElementById('cart-message');
        messageDiv.textContent = message;
        messageDiv.classList.remove('hidden');
        setTimeout(() => messageDiv.classList.add('hidden'), 3000);
    }

    function updateAllCartControls() {
        const cart = getCart();
        document.querySelectorAll('.menu-item').forEach(item => {
            const dishId = item.dataset.dishId;
            const cartControls = item.querySelector('.cart-controls');
            const addButton = cartControls.querySelector('.add-to-cart');
            const quantityControls = cartControls.querySelector('.quantity-controls');
            const quantityInput = quantityControls.querySelector('.quantity-input');
            const cartItem = cart.find(cartItem => cartItem.dish_id === dishId);

            if (cartItem) {
                addButton.classList.add('hidden');
                quantityControls.classList.remove('hidden');
                quantityInput.value = cartItem.quantity;
            } else {
                addButton.classList.remove('hidden');
                quantityControls.classList.add('hidden');
                quantityInput.value = 0;
            }
        });
    }

    // Cart control event listeners
    document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent modal from opening
            const dish = {
                dish_id: button.closest('.menu-item').dataset.dishId,
                name: button.closest('.menu-item').dataset.name,
                price: parseFloat(button.closest('.menu-item').dataset.price),
                calories: parseFloat(button.closest('.menu-item').dataset.calories),
                protein: parseFloat(button.closest('.menu-item').dataset.protein),
                fat: parseFloat(button.closest('.menu-item').dataset.fat),
                carbs: parseFloat(button.closest('.menu-item').dataset.carbs),
                image: button.closest('.menu-item').dataset.image
            };
            addToCart(dish);
        });
    });

    document.querySelectorAll('.increase-quantity').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent modal from opening
            const dishId = button.closest('.cart-controls').dataset.dishId;
            const quantityInput = button.closest('.quantity-controls').querySelector('.quantity-input');
            const newQuantity = parseInt(quantityInput.value) + 1;
            updateCartItemQuantity(dishId, newQuantity);
        });
    });

    document.querySelectorAll('.decrease-quantity').forEach(button => {
        button.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent modal from opening
            const dishId = button.closest('.cart-controls').dataset.dishId;
            const quantityInput = button.closest('.quantity-controls').querySelector('.quantity-input');
            const newQuantity = parseInt(quantityInput.value) - 1;
            updateCartItemQuantity(dishId, newQuantity);
        });
    });

    document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('input', (e) => {
            e.stopPropagation(); // Prevent modal from opening
            const dishId = input.closest('.cart-controls').dataset.dishId;
            const newQuantity = parseInt(input.value);
            if (newQuantity >= 0) {
                updateCartItemQuantity(dishId, newQuantity);
            } else {
                input.value = getCart().find(item => item.dish_id === dishId)?.quantity || 0;
            }
        });
    });

    // Modal functionality
    const modal = document.getElementById('dish-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const modalAddToCart = document.getElementById('modal-add-to-cart');

    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
            if (e.target.closest('.cart-controls')) return;
            populateModal(item);
            modal.classList.remove('hidden');
        });
    });

    function populateModal(item) {
        document.getElementById('modal-image').src = item.dataset.image;
        document.getElementById('modal-name').textContent = item.dataset.name;
        document.getElementById('modal-description').textContent = item.dataset.description;
        document.getElementById('modal-price').textContent = `${item.dataset.price} ‚ÇΩ`;
        document.getElementById('modal-calories').textContent = `${item.dataset.calories} –∫–∫–∞–ª`;
        document.getElementById('modal-protein').textContent = `${item.dataset.protein} –≥`;
        document.getElementById('modal-fat').textContent = `${item.dataset.fat} –≥`;
        document.getElementById('modal-carbs').textContent = `${item.dataset.carbs} –≥`;
        modalAddToCart.dataset.dishId = item.dataset.dishId;
    }

    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });

    function closeModal() {
        modal.classList.add('hidden');
    }

    modalAddToCart.addEventListener('click', () => {
        const dishId = modalAddToCart.dataset.dishId;
        const dishItem = document.querySelector(`.menu-item[data-dish-id="${dishId}"]`);
        const addButton = dishItem.querySelector('.add-to-cart');
        if (addButton && !addButton.classList.contains('hidden')) {
            addButton.click();
        } else {
            const increaseBtn = dishItem.querySelector('.increase-quantity');
            if (increaseBtn) increaseBtn.click();
        }
        closeModal();
    });

    // Initialize cart controls and counter on page load
    document.addEventListener('DOMContentLoaded', () => {
        updateCartCounter();
        updateAllCartControls();
    });

    // Filter logic
    const categoryButtons = document.querySelectorAll('.category-buttons .filter-btn');
    const calorieSelect = document.getElementById('calories');
    const menuItems = document.querySelectorAll('.menu-item');

    categoryButtons.forEach(button => {
        button.addEventListener('click', () => {
            categoryButtons.forEach(btn => btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500'));
            button.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
            filterMenu();
        });
    });

    calorieSelect.addEventListener('change', filterMenu);

    function filterMenu() {
        const activeCategory = document.querySelector('.category-buttons .filter-btn.bg-orange-500')?.dataset.category || 'all';
        const activeCalories = calorieSelect.value;

        menuItems.forEach(item => {
            const itemCategory = item.dataset.category;
            const itemCalories = parseInt(item.dataset.calories);
            let showItem = true;

            if (activeCategory !== 'all' && activeCategory !== itemCategory) {
                showItem = false;
            }

            if (activeCalories !== 'all') {
                const [minCal, maxCal] = activeCalories.split('-').map(Number);
                if (itemCalories < minCal || (maxCal && itemCalories > maxCal)) {
                    showItem = false;
                }
            }

            item.style.display = showItem ? 'flex' : 'none';
        });
    }

    document.querySelector('.category-buttons .filter-btn[data-category="all"]').classList.add('bg-orange-500', 'text-white', 'border-orange-500');

    const categoryContainer = document.querySelector('.category-buttons');
    let isDown = false;
    let startX;
    let scrollLeft;

    categoryContainer.addEventListener('mousedown', (e) => {
        isDown = true;
        startX = e.pageX - categoryContainer.offsetLeft;
        scrollLeft = categoryContainer.scrollLeft;
    });

    categoryContainer.addEventListener('mouseleave', () => {
        isDown = false;
    });

    categoryContainer.addEventListener('mouseup', () => {
        isDown = false;
    });

    categoryContainer.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - categoryContainer.offsetLeft;
        const walk = (x - startX) * 2;
        categoryContainer.scrollLeft = scrollLeft - walk;
    });
</script>
{% endblock %}