{% extends "base.html" %}

{% block title %}Корзина и оформление заказа{% endblock %}

{% block additional_styles %}
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.quantity-input {
    -moz-appearance: textfield;
}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-3xl font-bold text-orange-500 mb-8">Оформление заказа</h1>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Корзина -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-4">Ваша корзина</h2>
            <div id="cart-items" class="space-y-6">
                {% for item in cart_items %}
                <div class="cart-item flex gap-4 border-b border-gray-200 pb-4">
                    <img src="{{ item.image }}" alt="{{ item.name }}" class="w-24 h-24 object-cover rounded-lg">
                    <div class="flex-1">
                        <h3 class="text-lg font-semibold">{{ item.name }}</h3>
                        <p class="text-sm text-gray-600">{{ item.calories }} ккал</p>
                        <p class="text-sm text-gray-600">{{ item.price }} ₽</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button class="decrease-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">-</button>
                        <input type="number" class="quantity-input w-12 text-center" value="{{ item.quantity }}" min="1"
                            data-price="{{ item.price }}"
                            data-calories="{{ item.calories }}"
                            data-protein="{{ item.protein }}"
                            data-fat="{{ item.fat }}"
                            data-carbs="{{ item.carbs }}">
                        <button class="increase-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors">+</button>
                        <button class="remove-item text-red-500 hover:text-red-600 transition-colors">✕</button>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Общий КБЖУ</h3>
                <p class="text-sm text-gray-600">
                    Калории: <span id="total-calories">0</span> ккал<br>
                    Белки: <span id="total-protein">0</span> г<br>
                    Жиры: <span id="total-fat">0</span> г<br>
                    Углеводы: <span id="total-carbs">0</span> г
                </p>
                <div class="flex justify-between text-lg font-semibold mt-4">
                    <span>Итого:</span>
                    <span id="cart-total">0 ₽</span>
                </div>
            </div>
        </div>

        <!-- Форма оформления заказа -->
        <div class="bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-4">Детали заказа</h2>
            
            <!-- Способ получения -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Способ получения</h3>
                <div class="flex gap-4">
                    {% for method in delivery_methods %}
                    <button class="delivery-method px-4 py-2 border border-gray-300 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-orange-500 hover:text-white hover:border-orange-500 transition-all" data-method="{{ method.id }}">{{ method.name }}</button>
                    {% endfor %}
                </div>
            </div>

            <!-- Поля для доставки -->
            <div id="delivery-fields" class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Адрес доставки</h3>
                <input type="text" id="address" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" placeholder="Введите адрес" value="{{ user_address|default('') }}">
            </div>

            <!-- Поля для самовывоза -->
            <div id="pickup-fields" class="mb-6 hidden">
                <h3 class="text-lg font-semibold mb-3">Выберите ресторан</h3>
                <select id="restaurant" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                    {% for restaurant in restaurants %}
                    <option value="{{ restaurant.id }}">{{ restaurant.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Способ оплаты -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Способ оплаты</h3>
                <select id="payment" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                    {% for payment_method in payment_methods %}
                    <option value="{{ payment_method.id }}">{{ payment_method.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Кнопка оформления -->
            <button id="submit-order" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition-colors">Оформить заказ</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Переключение способа получения
    const deliveryMethods = document.querySelectorAll('.delivery-method');
    const deliveryFields = document.getElementById('delivery-fields');
    const pickupFields = document.getElementById('pickup-fields');

    deliveryMethods.forEach(button => {
        button.addEventListener('click', () => {
            deliveryMethods.forEach(btn => btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500'));
            button.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
            const method = button.dataset.method;
            deliveryFields.classList.toggle('hidden', method !== 'delivery');
            pickupFields.classList.toggle('hidden', method !== 'pickup');
        });
    });

    // Установить "Доставка" по умолчанию
    document.querySelector('.delivery-method[data-method="delivery"]').classList.add('bg-orange-500', 'text-white', 'border-orange-500');

    // Управление корзиной и расчет КБЖУ
    const cartItems = document.querySelectorAll('.cart-item');
    const cartTotalElement = document.getElementById('cart-total');
    const totalCaloriesElement = document.getElementById('total-calories');
    const totalProteinElement = document.getElementById('total-protein');
    const totalFatElement = document.getElementById('total-fat');
    const totalCarbsElement = document.getElementById('total-carbs');

    function updateCartTotals() {
        let totalPrice = 0;
        let totalCalories = 0;
        let totalProtein = 0;
        let totalFat = 0;
        let totalCarbs = 0;

        cartItems.forEach(item => {
            const quantity = parseInt(item.querySelector('.quantity-input').value);
            const input = item.querySelector('.quantity-input');
            totalPrice += quantity * parseFloat(input.dataset.price);
            totalCalories += quantity * parseFloat(input.dataset.calories);
            totalProtein += quantity * parseFloat(input.dataset.protein);
            totalFat += quantity * parseFloat(input.dataset.fat);
            totalCarbs += quantity * parseFloat(input.dataset.carbs);
        });

        cartTotalElement.textContent = `${totalPrice} ₽`;
        totalCaloriesElement.textContent = totalCalories;
        totalProteinElement.textContent = totalProtein;
        totalFatElement.textContent = totalFat;
        totalCarbsElement.textContent = totalCarbs;
    }

    cartItems.forEach(item => {
        const quantityInput = item.querySelector('.quantity-input');
        const increaseBtn = item.querySelector('.increase-quantity');
        const decreaseBtn = item.querySelector('.decrease-quantity');
        const removeBtn = item.querySelector('.remove-item');

        increaseBtn.addEventListener('click', () => {
            quantityInput.value = parseInt(quantityInput.value) + 1;
            updateCartTotals();
        });

        decreaseBtn.addEventListener('click', () => {
            if (quantityInput.value > 1) {
                quantityInput.value = parseInt(quantityInput.value) - 1;
                updateCartTotals();
            }
        });

        quantityInput.addEventListener('input', () => {
            if (quantityInput.value < 1) quantityInput.value = 1;
            updateCartTotals();
        });

        removeBtn.addEventListener('click', () => {
            item.remove();
            updateCartTotals();
        });
    });

    // Инициализация итогов
    updateCartTotals();
</script>
{% endblock %}