{% extends "base.html" %}

{% block title %}Корзина и оформление заказа{% endblock %}

{% block additional_styles %}
.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.quantity-input {
    -moz-appearance: textfield;
}
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 24px;
    border-radius: 8px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    z-index: 1000;
    display: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.notification.success {
    background-color: #22c55e; /* Tailwind green-500 */
}
.notification.error {
    background-color: #ef4444; /* Tailwind red-500 */
}
.notification.visible {
    display: block;
    opacity: 1;
    transform: translateY(0);
}
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <h1 class="text-3xl font-bold text-orange-500 mb-8">Оформление заказа</h1>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart -->
        <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-4">Ваша корзина</h2>
            <div id="cart-items" class="space-y-6"></div>
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2">Общий КБЖУ</h3>
                <p class="text-sm text-gray-600">
                    Калории: <span id="total-calories">0</span> ккал<br>
                    Белки: <span id="total-protein">0</span> г<br>
                    Жиры: <span id="total-fat">0</span> г<br>
                    Углеводы: <span id="total-carbs">0</span> г
                </p>
                <div class="flex justify-between text-lg font-semibold mt-4">
                    <span>Итого:</span>
                    <span id="cart-total">0 ₽</span>
                </div>
            </div>
        </div>

        <!-- Order Form -->
        <div class="bg-white p-6 rounded-2xl shadow-md">
            <h2 class="text-xl font-semibold mb-4">Детали заказа</h2>
            
            <!-- Delivery Method -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Способ получения</h3>
                <div class="flex gap-4">
                    {% for method in delivery_methods %}
                    <button class="delivery-method px-4 py-2 border border-gray-300 rounded-full text-sm font-semibold whitespace-nowrap hover:bg-orange-500 hover:text-white hover:border-orange-500 transition-all" data-method="{{ method.id }}">{{ method.name }}</button>
                    {% endfor %}
                </div>
            </div>

            <!-- Delivery Fields -->
            <div id="delivery-fields" class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Адрес доставки</h3>
                <input type="text" id="address" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all" placeholder="Введите адрес" value="{{ user_address|default('') }}">
            </div>

            <!-- Pickup Fields -->
            <div id="pickup-fields" class="mb-6 hidden">
                <h3 class="text-lg font-semibold mb-3">Выберите ресторан</h3>
                <select id="restaurant" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                    {% for restaurant in restaurants %}
                    <option value="{{ restaurant.id }}">{{ restaurant.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Payment Method -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3">Способ оплаты</h3>
                <select id="payment" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all">
                    {% for payment_method in payment_methods %}
                    <option value="{{ payment_method.id }}">{{ payment_method.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Submit Order Button with Auth Check -->
            {% if request.cookies.get('access_token') %}
                <button id="submit-order" class="w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition-colors">Оформить заказ</button>
            {% else %}
                <p class="text-sm text-gray-600 text-center">Войдите, чтобы оформить заказ</p>
                <a href="{{ url_for('login') }}" class="block w-full bg-green-500 text-white py-3 rounded-full font-semibold hover:bg-green-600 transition-colors text-center">Войти</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Cart management functions
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '[]');
    }

    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartCounter();
        renderCart();
    }

    function updateCartCounter() {
        const cart = getCart();
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const counter = document.getElementById('cart-counter');
        if (counter) {
            counter.textContent = totalItems || '';
            counter.classList.toggle('hidden', totalItems === 0);
        }
    }

    function showNotification(message, type = 'error') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} visible`;
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateY(0)';
        }, 10);
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                notification.classList.remove('visible');
            }, 300);
        }, 3000);
    }

    function renderCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        const cart = getCart();
        cartItemsContainer.innerHTML = '';

        if (cart.length === 0) {
            cartItemsContainer.innerHTML = '<p class="text-sm text-gray-600">Корзина пуста</p>';
        } else {
            cart.forEach((item, index) => {
                const itemHtml = `
                    <div class="cart-item flex gap-4 border-b border-gray-200 pb-4">
                        <img src="${item.image}" alt="${item.name}" class="w-24 h-24 object-cover rounded-lg">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold">${item.name}</h3>
                            <p class="text-sm text-gray-600">${item.calories} ккал</p>
                            <p class="text-sm text-gray-600">${item.price.toFixed(2)} ₽</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="decrease-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors" data-index="${index}">-</button>
                            <input type="number" class="quantity-input w-12 text-center border border-gray-300 rounded-lg" value="${item.quantity}" min="1" data-index="${index}">
                            <button class="increase-quantity w-8 h-8 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors" data-index="${index}">+</button>
                            <button class="remove-item text-red-500 hover:text-red-600 transition-colors" data-index="${index}">✕</button>
                        </div>
                    </div>
                `;
                cartItemsContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
        }

        // Update totals
        updateCartTotals();
    }

    function updateCartTotals() {
        const cart = getCart();
        let totalPrice = 0;
        let totalCalories = 0;
        let totalProtein = 0;
        let totalFat = 0;
        let totalCarbs = 0;

        cart.forEach(item => {
            const quantity = item.quantity;
            totalPrice += quantity * item.price;
            totalCalories += quantity * item.calories;
            totalProtein += quantity * item.protein;
            totalFat += quantity * item.fat;
            totalCarbs += quantity * item.carbs;
        });

        document.getElementById('cart-total').textContent = `${totalPrice.toFixed(2)} ₽`;
        document.getElementById('total-calories').textContent = totalCalories.toFixed(0);
        document.getElementById('total-protein').textContent = totalProtein.toFixed(0);
        document.getElementById('total-fat').textContent = totalFat.toFixed(0);
        document.getElementById('total-carbs').textContent = totalCarbs.toFixed(0);
    }

    // Event listeners for cart interactions
    document.addEventListener('click', (e) => {
        const cart = getCart();
        const index = parseInt(e.target.dataset.index);

        if (e.target.classList.contains('increase-quantity')) {
            cart[index].quantity++;
            saveCart(cart);
        } else if (e.target.classList.contains('decrease-quantity')) {
            if (cart[index].quantity > 1) {
                cart[index].quantity--;
                saveCart(cart);
            }
        } else if (e.target.classList.contains('remove-item')) {
            cart.splice(index, 1);
            saveCart(cart);
        }
    });

    document.addEventListener('input', (e) => {
        if (e.target.classList.contains('quantity-input')) {
            const index = parseInt(e.target.dataset.index);
            const value = parseInt(e.target.value);
            const cart = getCart();
            if (value >= 1) {
                cart[index].quantity = value;
                saveCart(cart);
            } else {
                e.target.value = cart[index].quantity;
            }
        }
    });

    // Delivery method toggle
    const deliveryMethods = document.querySelectorAll('.delivery-method');
    const deliveryFields = document.getElementById('delivery-fields');
    const pickupFields = document.getElementById('pickup-fields');

    deliveryMethods.forEach(button => {
        button.addEventListener('click', () => {
            deliveryMethods.forEach(btn => btn.classList.remove('bg-orange-500', 'text-white', 'border-orange-500'));
            button.classList.add('bg-orange-500', 'text-white', 'border-orange-500');
            const method = button.dataset.method;
            deliveryFields.classList.toggle('hidden', method !== 'delivery');
            pickupFields.classList.toggle('hidden', method !== 'pickup');
        });
    });

    document.querySelector('.delivery-method[data-method="delivery"]').classList.add('bg-orange-500', 'text-white', 'border-orange-500');

    // Submit order event listener
    const submitOrderBtn = document.getElementById('submit-order');
    if (submitOrderBtn) {
        submitOrderBtn.addEventListener('click', async () => {
            const cart = getCart();
            if (cart.length === 0) {
                showNotification('Корзина пуста', 'error');
                return;
            }

            const activeDeliveryMethod = document.querySelector('.delivery-method.bg-orange-500')?.dataset.method;
            let deliveryAddress = null;
            let restaurantId = null;
            if (activeDeliveryMethod === 'delivery') {
                deliveryAddress = document.getElementById('address').value;
                if (!deliveryAddress) {
                    showNotification('Введите адрес доставки', 'error');
                    return;
                }
            } else if (activeDeliveryMethod === 'pickup') {
                restaurantId = document.getElementById('restaurant').value;
                if (!restaurantId) {
                    showNotification('Выберите ресторан', 'error');
                    return;
                }
            }

            const paymentMethod = document.getElementById('payment').value;

            const orderData = {
                items: cart,
                delivery_type: activeDeliveryMethod,
                delivery_address: deliveryAddress,
                restaurant_id: restaurantId,
                payment_method: paymentMethod
            };

            try {
                const response = await fetch('/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                if (response.ok) {
                    const data = await response.json();
                    localStorage.removeItem('cart');
                    // showNotification('Заказ успешно создан!', 'success');
                    setTimeout(() => {
                        window.location.href = `/orders/${data.order_id}`;  // Redirect to order confirmation
                    }, 0);
                } else {
                    showNotification(`Ошибка при создании заказа ${await response.json()}`, 'error');
                }
            } catch (error) {
                showNotification(`Произошла ошибка ${error}`, 'error');
            }
        });
    }

    // Initialize cart on page load
    document.addEventListener('DOMContentLoaded', () => {
        renderCart();
        updateCartCounter();
    });
</script>
{% endblock %}